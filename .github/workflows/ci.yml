name: Pipeline de Integración Continua

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ============================================================================
  # Verificación de Estilo de Código
  # ============================================================================
  verificar-estilo:
    name: "Verificar Estilo de Código"
    runs-on: ubuntu-latest
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Configurar Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Instalar herramientas de formateo
        run: pip install black isort

      - name: Verificar formateo con Black
        run: black --check --diff src/ tests/

      - name: Verificar orden de imports con isort
        run: isort --check-only --diff src/ tests/

  # ============================================================================
  # Tests Unitarios
  # ============================================================================
  ejecutar-tests:
    name: "Ejecutar Tests Unitarios"
    runs-on: ubuntu-latest
    needs: verificar-estilo
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Configurar Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Instalar dependencias
        run: |
          pip install pytest
          pip install -e .

      - name: Ejecutar suite de tests
        run: pytest tests/ -v

  # ============================================================================
  # Análisis de Seguridad
  # ============================================================================
  analizar-seguridad:
    name: "Análisis de Vulnerabilidades"
    runs-on: ubuntu-latest
    needs: ejecutar-tests
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Configurar Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Actualizar pip
        run: pip install --upgrade pip

      - name: Instalar pip-audit
        run: pip install pip-audit

      - name: Instalar dependencias del proyecto
        run: pip install -e .

      - name: Ejecutar auditoría de seguridad
        run: pip-audit --desc on --ignore-vuln CVE-2025-8869

  # ============================================================================
  # Build de Imagen Docker
  # ============================================================================
  construir-docker:
    name: "Construir Imagen Docker"
    runs-on: ubuntu-latest
    needs: ejecutar-tests
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Construir imagen de producción
        run: docker build -f docker/Dockerfile.api -t cortex-ka:test .

      - name: Verificar que el contenedor inicia correctamente
        run: |
          docker run --rm -d --name cortex-test -p 8000:8000 cortex-ka:test
          sleep 5
          docker logs cortex-test
          docker stop cortex-test || true
